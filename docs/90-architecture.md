# 90 整体架构设计

## 概述

Leek Core 是一个事件驱动的量化交易框架，采用分层架构设计，将数据获取、策略计算、风险控制、订单执行等功能模块化。框架支持实盘交易和回测验证，提供统一的组件接口和生命周期管理。

## 架构分层

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                           应用层 (Application)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   实盘交易   │  │   策略回测   │  │   因子研究   │  │   模型训练   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │
├─────────────────────────────────────────────────────────────────────────┤
│                           引擎层 (Engine)                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      SimpleEngine / GrpcEngine                   │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │   │
│  │  │DataMgr   │ │StrategyMgr│ │ ExecutorMgr│ │ Portfolio │           │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────────────┤
│                           业务层 (Business)                             │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────┐  │
│  │  Strategy │ │ Indicator │ │   Factor  │ │    Risk   │ │  Alarm  │  │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └─────────┘  │
├─────────────────────────────────────────────────────────────────────────┤
│                           基础设施层 (Infrastructure)                    │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────┐  │
│  │ EventBus  │ │DataSource │ │ Executor  │ │   Models  │ │  Utils  │  │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └─────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## 核心设计原则

### 1. 事件驱动

所有组件通过事件总线（EventBus）进行通信，实现松耦合：

```text
DataSource ──► DATA_RECEIVED ──► Strategy ──► STRATEGY_SIGNAL ──► Portfolio
                                                                      │
Executor ◄── ORDER_CREATED ◄────────────────────────────────────────┘
    │
    └──► ORDER_UPDATED ──► Portfolio ──► POSITION_UPDATE
```

### 2. 组件化

所有功能模块继承自 `LeekComponent` 基类，具有统一的生命周期：

```python
class LeekComponent:
    display_name: str = None
    init_params: List[Field] = []
    
    def on_start(self): ...    # 启动
    def on_stop(self): ...     # 停止
    def get_state(self): ...   # 获取状态
    def load_state(self): ...  # 加载状态
    def on_event(self): ...    # 处理事件
```

### 3. 可插拔

通过配置动态加载组件，支持运行时增删：

```python
# 动态加载类
cls = load_class_from_str("leek_core.strategy.CTAStrategy")

# 创建组件实例
component = create_component(cls, **params)
```

### 4. 双模支持

同时支持实盘和回测，通过不同的执行器实现：

```text
实盘模式:
  DataSource(WebSocket) → Engine → Executor(Gate/OKX/Binance)

回测模式:
  DataSource(ClickHouse) → Engine → Executor(Backtest)
```

## 数据流架构

### 实盘数据流

```text
┌──────────────────────────────────────────────────────────────────────┐
│                         数据流 (Data Flow)                            │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│   交易所 WebSocket                                                    │
│        │                                                              │
│        ▼                                                              │
│   ┌─────────────┐    KLine     ┌─────────────┐                       │
│   │ DataSource  │ ──────────►  │   Engine    │                       │
│   └─────────────┘              │             │                       │
│                                │  on_data()  │                       │
│                                └──────┬──────┘                       │
│                                       │                              │
│                    ┌──────────────────┼──────────────────┐           │
│                    ▼                  ▼                  ▼           │
│           ┌──────────────┐   ┌──────────────┐   ┌──────────────┐    │
│           │StrategyMgr   │   │PositionTracker│   │   EventBus   │    │
│           │              │   │              │   │              │    │
│           │ process_data │   │ update_price │   │ publish      │    │
│           └──────┬───────┘   └──────────────┘   └──────────────┘    │
│                  │                                                   │
│                  ▼                                                   │
│           ┌──────────────┐                                          │
│           │   Signal     │                                          │
│           └──────┬───────┘                                          │
│                  │                                                   │
│                  ▼                                                   │
│           ┌──────────────┐   风控检查    ┌──────────────┐           │
│           │  Portfolio   │ ◄──────────► │ RiskManager  │           │
│           │              │              └──────────────┘           │
│           │ process_signal│                                         │
│           └──────┬───────┘                                          │
│                  │                                                   │
│                  ▼                                                   │
│           ┌──────────────┐    冻结资金   ┌──────────────┐           │
│           │ExecutionCtx  │ ◄──────────► │CapitalAccount│           │
│           └──────┬───────┘              └──────────────┘           │
│                  │                                                   │
│                  ▼                                                   │
│           ┌──────────────┐                                          │
│           │ExecutorMgr   │                                          │
│           │              │                                          │
│           │ handle_order │                                          │
│           └──────┬───────┘                                          │
│                  │                                                   │
│                  ▼                                                   │
│           ┌──────────────┐                                          │
│           │  Executor    │ ◄─────── 交易所 API                       │
│           │              │                                          │
│           │ send_order   │                                          │
│           └──────────────┘                                          │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

### 订单回调流

```text
┌──────────────────────────────────────────────────────────────────────┐
│                       订单回调流 (Order Callback)                     │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│   交易所推送 / 轮询                                                   │
│        │                                                              │
│        ▼                                                              │
│   ┌─────────────┐                                                    │
│   │  Executor   │                                                    │
│   │             │                                                    │
│   │ _trade_callback                                                  │
│   └──────┬──────┘                                                    │
│          │                                                           │
│          ▼                                                           │
│   ┌─────────────┐    ORDER_UPDATED    ┌─────────────┐               │
│   │ExecutorCtx  │ ────────────────►   │  EventBus   │               │
│   └─────────────┘                     └──────┬──────┘               │
│                                              │                       │
│                                              ▼                       │
│                                       ┌─────────────┐               │
│                                       │   Engine    │               │
│                                       │             │               │
│                                       │on_order_update              │
│                                       └──────┬──────┘               │
│                                              │                       │
│                         ┌────────────────────┼────────────────────┐ │
│                         ▼                    ▼                    ▼ │
│                  ┌──────────────┐   ┌──────────────┐   ┌────────────┐│
│                  │  Portfolio   │   │ExecutorMgr   │   │StrategyMgr││
│                  │              │   │              │   │            ││
│                  │ order_update │   │ order_update │   │exec_update ││
│                  └──────┬───────┘   └──────────────┘   └────────────┘│
│                         │                                            │
│           ┌─────────────┼─────────────┐                             │
│           ▼             ▼             ▼                             │
│   ┌──────────────┐┌──────────────┐┌──────────────┐                  │
│   │CapitalAccount││PositionTracker││  统计数据    │                  │
│   │              ││              ││              │                  │
│   │unfreeze_amount││order_update ││ pnl/fee/... │                  │
│   └──────────────┘└──────────────┘└──────────────┘                  │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

## 模块依赖图

```text
                           ┌─────────┐
                           │  utils  │
                           └────┬────┘
                                │
          ┌─────────────────────┼─────────────────────┐
          │                     │                     │
          ▼                     ▼                     ▼
    ┌─────────┐           ┌─────────┐           ┌─────────┐
    │ models  │           │  event  │           │  base   │
    └────┬────┘           └────┬────┘           └────┬────┘
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               │
          ┌────────────────────┼────────────────────┐
          │                    │                    │
          ▼                    ▼                    ▼
    ┌─────────┐          ┌─────────┐          ┌─────────┐
    │  data   │          │ strategy│          │executor │
    └────┬────┘          └────┬────┘          └────┬────┘
         │                    │                    │
         │              ┌─────┴─────┐              │
         │              ▼           ▼              │
         │        ┌─────────┐ ┌─────────┐         │
         │        │indicator│ │sub_strat│         │
         │        └─────────┘ └─────────┘         │
         │                                        │
         └────────────────────┬───────────────────┘
                              │
                              ▼
                        ┌─────────┐
                        │position │
                        └────┬────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
    ┌─────────┐        ┌─────────┐        ┌─────────┐
    │  risk   │        │ policy  │        │ manager │
    └─────────┘        └─────────┘        └─────────┘
                             │
                             ▼
                        ┌─────────┐
                        │ engine  │
                        └────┬────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
    ┌─────────┐        ┌─────────┐        ┌─────────┐
    │backtest │        │  alarm  │        │   ml    │
    └─────────┘        └─────────┘        └─────────┘
```

## 扩展点

### 1. 数据源扩展

```python
from leek_core.data import DataSource

class MyDataSource(DataSource):
    """自定义数据源"""
    
    async def get_klines(self, symbol, timeframe, start, end):
        # 实现数据获取逻辑
        ...
```

### 2. 策略扩展

```python
from leek_core.strategy import CTAStrategy

class MyStrategy(CTAStrategy):
    """自定义策略"""
    
    def on_kline(self, kline):
        # 处理K线
        ...
    
    def should_open(self):
        # 开仓逻辑
        ...
```

### 3. 执行器扩展

```python
from leek_core.executor import Executor

class MyExecutor(Executor):
    """自定义执行器"""
    
    def send_order(self, order):
        # 发送订单
        ...
```

### 4. 指标扩展

```python
from leek_core.indicators import T

class MyIndicator(T):
    """自定义指标"""
    
    def update(self, kline):
        # 计算指标
        ...
```

### 5. 风控扩展

```python
from leek_core.sub_strategy import SubStrategy

class MyRiskControl(SubStrategy):
    """自定义风控"""
    
    def evaluate(self, data, position):
        # 评估仓位
        ...
```

## 部署架构

### 单机部署

```text
┌─────────────────────────────────────────────┐
│                   单机服务器                  │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │            Python 进程               │   │
│  │  ┌─────────────────────────────┐   │   │
│  │  │       SimpleEngine          │   │   │
│  │  │  - DataSource (WebSocket)   │   │   │
│  │  │  - Strategy                 │   │   │
│  │  │  - Executor (REST/WS)       │   │   │
│  │  └─────────────────────────────┘   │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │            数据存储                  │   │
│  │  - ClickHouse (K线数据)             │   │
│  │  - Redis (状态缓存)                 │   │
│  │  - SQLite (配置)                    │   │
│  └─────────────────────────────────────┘   │
│                                             │
└─────────────────────────────────────────────┘
```

### 分布式部署

```text
┌────────────────────────────────────────────────────────────────────┐
│                           负载均衡器                                │
└─────────────────────────────┬──────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│   Manager     │     │   Engine-1    │     │   Engine-2    │
│   (主进程)    │     │   (子进程)    │     │   (子进程)    │
│               │     │               │     │               │
│  - API Server │     │  - 策略A     │     │  - 策略B      │
│  - 配置管理   │     │  - 执行器A   │     │  - 执行器B    │
│  - 监控告警   │     │  - gRPC      │     │  - gRPC       │
└───────┬───────┘     └───────┬───────┘     └───────┬───────┘
        │                     │                     │
        │   gRPC              │                     │
        └─────────────────────┴─────────────────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │   共享存储        │
                    │  - ClickHouse    │
                    │  - Redis         │
                    │  - PostgreSQL    │
                    └───────────────────┘
```

## 性能考量

### 1. 事件处理优化

- EventBus 使用线程池并行处理
- 每个订阅者独立队列保证顺序
- 心跳机制检测连接状态

### 2. 数据缓存

- 历史数据本地缓存
- 指标计算结果复用
- 仓位状态内存缓存

### 3. 异步处理

- WebSocket 异步连接
- 订单回调异步处理
- gRPC 异步服务

## 相关文档

- [引擎架构](20-engine.md) - SimpleEngine 详情
- [事件总线](22-event-bus.md) - EventBus 设计
- [组件开发指南](91-component-guide.md) - 自定义组件开发
